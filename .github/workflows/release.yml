name: Release

on:
  release:
    types: [released, prereleased]

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: vibe-linux-x64
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            artifact: vibe-linux-arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: vibe-darwin-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: vibe-darwin-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: vibe-windows-x64.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        env:
          MISE_HTTP_TIMEOUT: "120"

      - name: Build release binary
        run: deno task compile:ci --target ${{ matrix.target }} --output ${{ matrix.artifact }} --distribution binary

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  build-deb:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            binary: vibe-linux-x64
          - arch: arm64
            binary: vibe-linux-arm64

    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        env:
          MISE_HTTP_TIMEOUT: "120"

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.binary }}
          path: .

      - name: Rebuild with deb distribution metadata
        run: |
          TARGET="${{ matrix.arch == 'amd64' && 'x86_64-unknown-linux-gnu' || 'aarch64-unknown-linux-gnu' }}"
          deno task compile:ci --target "$TARGET" --output vibe-deb --distribution deb

      - name: Build .deb package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          deno task build:deb "$VERSION" ${{ matrix.arch }} vibe-deb

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: vibe_${{ matrix.arch }}.deb
          path: vibe_*.deb

  release:
    needs: [build, build-deb]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Calculate SHA256
        id: sha256
        run: |
          echo "darwin_arm64=$(sha256sum artifacts/vibe-darwin-arm64 | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT
          echo "darwin_x64=$(sha256sum artifacts/vibe-darwin-x64 | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(sha256sum artifacts/vibe-linux-arm64 | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT
          echo "linux_x64=$(sha256sum artifacts/vibe-linux-x64 | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT

      - name: Determine Formula to update
        id: formula
        run: |
          if [ "${{ github.event.release.prerelease }}" = "true" ]; then
            echo "name=vibe-beta" >> $GITHUB_OUTPUT
            echo "template=vibe-beta.rb" >> $GITHUB_OUTPUT
          else
            echo "name=vibe" >> $GITHUB_OUTPUT
            echo "template=vibe.rb" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        with:
          path: vibe-source

      - name: Update Homebrew formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          FORMULA_NAME="${{ steps.formula.outputs.name }}"
          FORMULA_TEMPLATE="${{ steps.formula.outputs.template }}"

          gh repo clone kexi/homebrew-tap homebrew-tap

          # Copy template from source repository
          cp "vibe-source/Formula/${FORMULA_TEMPLATE}" "homebrew-tap/Formula/${FORMULA_TEMPLATE}"
          cd homebrew-tap

          # Replace placeholders with actual values
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" "Formula/${FORMULA_TEMPLATE}"
          sed -i "s/SHA256_DARWIN_ARM64/${{ steps.sha256.outputs.darwin_arm64 }}/g" "Formula/${FORMULA_TEMPLATE}"
          sed -i "s/SHA256_DARWIN_X64/${{ steps.sha256.outputs.darwin_x64 }}/g" "Formula/${FORMULA_TEMPLATE}"
          sed -i "s/SHA256_LINUX_ARM64/${{ steps.sha256.outputs.linux_arm64 }}/g" "Formula/${FORMULA_TEMPLATE}"
          sed -i "s/SHA256_LINUX_X64/${{ steps.sha256.outputs.linux_x64 }}/g" "Formula/${FORMULA_TEMPLATE}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Formula/${FORMULA_TEMPLATE}"
          git commit -m "Update ${FORMULA_NAME} to $VERSION"
          git push https://x-access-token:${GH_TOKEN}@github.com/kexi/homebrew-tap.git HEAD:main
