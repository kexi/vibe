> [!NOTE]
> :us: [English](./SECURITY_CHECKLIST.md)

# CLI セキュリティチェックリスト

vibe CLIツールの包括的なセキュリティチェックリストです。各カテゴリにはプロジェクトで使用している対策を記載しています。

## 1. コマンドインジェクション

- **リスク**: サニタイズされていないユーザー入力による任意コマンド実行
- **対策**: `spawn()` を配列引数で使用（シェル文字列結合は禁止）
- **適用**: ESLint `security/detect-child-process` + カスタムセキュリティチェックスクリプト

## 2. パストラバーサル

- **リスク**: `../` シーケンスによる意図しないディレクトリ外のファイルアクセス
- **対策**: `validatePath()` によるパス境界の検証
- **適用**: コードレビュー + ランタイムバリデーション

## 3. シンボリックリンク攻撃

- **リスク**: シンボリックリンクを経由した意図しないファイルのアクセス・変更
- **対策**: `realPath()` による解決 + 境界チェック
- **適用**: ファイル操作前のランタイムバリデーション

## 4. TOCTOU（チェック時と使用時の競合）

- **リスク**: セキュリティチェックと使用の間にファイル状態が変更される
- **対策**: `verifyTrustAndRead()` によるアトミックなチェック＆読み取り
- **適用**: 信頼検証のアーキテクチャパターン

## 5. 環境変数インジェクション

- **リスク**: 悪意のある環境変数値による動作への影響
- **対策**: 明示的な許可リストによる環境変数マージの制御
- **適用**: コードレビュー

## 6. ターミナルエスケープシーケンスインジェクション

- **リスク**: 出力内の悪意のあるエスケープシーケンスによるターミナル表示の操作
- **対策**: ユーザー向け出力での制御文字フィルタリング
- **適用**: 出力サニタイズユーティリティ

## 7. 引数インジェクション（`--` オプション注入）

- **リスク**: ユーザー入力がコマンドラインオプションとして解釈される（例: `--exec`）
- **対策**: 明示的な引数配列（文字列結合ではない）
- **適用**: `spawn()` 配列パターン + コードレビュー

## 8. サプライチェーン攻撃

- **リスク**: 侵害された依存関係による脆弱性の導入
- **対策**: ロックファイル固定 + `pnpm audit` + パッケージ公開後最低1日の待機ポリシー
- **適用**: CIでのロックファイル検証 + `--frozen-lockfile` + `--ignore-scripts`

## 9. 安全でない一時ファイル作成

- **リスク**: 予測可能な一時ファイル名によるシンボリックリンク攻撃
- **対策**: UUIDベースの命名 + アトミックリネーム操作
- **適用**: コードレビュー + fast-remove実装

## 10. シェル出力インジェクション

- **リスク**: 特殊文字（シングルクォートなど）を含むパスが `eval` 時にシェルインジェクションを引き起こす
- **対策**: `escapeShellPath()` による全 `cd` 出力でのシングルクォートエスケープ
- **適用**: カスタムセキュリティチェックスクリプトがエスケープなしの `cd` パターンを検出

## 11. 設定ファイルポイズニング

- **リスク**: 悪意のある `.vibe.toml` がフック経由で任意コマンドを実行
- **対策**: SHA-256信頼メカニズム — フック実行前に設定を明示的に信頼する必要がある
- **適用**: `trust`/`untrust`/`verify` コマンド + ハッシュ検証

## 12. 安全でない正規表現（ReDoS）

- **リスク**: 壊滅的なバックトラッキングを持つ正規表現によるサービス拒否
- **対策**: ESLint `security/detect-unsafe-regex` ルール
- **適用**: CIでのESLint + pre-commitチェック

## 13. eval / 動的コード実行

- **リスク**: 動的に構築されたコードの実行による任意コード実行
- **対策**: プロダクションコードでの `eval()` や `new Function()` の禁止
- **適用**: ESLint `security/detect-eval-with-expression` + カスタムセキュリティチェックスクリプト
- **例外**: `.vibedev` は開発利便性のために `eval` を使用（警告付きで文書化）

---

## 自動適用

| ツール                         | スコープ           | タイミング                |
| ------------------------------ | ------------------ | ------------------------- |
| ESLint セキュリティプラグイン  | 静的解析           | `pnpm run lint`           |
| カスタムセキュリティスクリプト | パターンマッチング | `pnpm run security:check` |
| Claude Code フック             | 編集時チェック     | PostToolUse (Write/Edit)  |
| CI security-check ジョブ       | PR ゲート          | プッシュ/PR ごと          |
